# EZT_Office
## üìö Contents
- üöÄ [Install](#-install)
- üîß [Core Functions](#-core-functions)
- üí° [Usage Examples](#-usage-examples)

## Install
### Trong settings.gradle.kts ho·∫∑c build.gradle c·∫•p project
```gradle
repositories {
    google()
    mavenCentral()
    maven {
        name = "GitHubPackages"
        url = uri("https://maven.pkg.github.com/TanhB02/EZT_Office")
        credentials {
            username = "TanhB02"
            password = "MY_TOKEN"
        }
    }
}


### build.gradle (Module:app)
```gradle
dependencies {
    implementation "ezt.documents:libreoffice:release-1.0.0"
}
```

### üîß Core Functions
| Function | M√¥ t·∫£ | Return | L∆∞u √Ω |
|----------|-------|--------|-------|
| `openFile(context: Context, uri: Uri, callback: DocumentCallback)` | M·ªü file b·∫±ng LibreOffice (`LOActivity`). T·ª± ƒë·ªông c·∫•p quy·ªÅn URI v√† ƒëƒÉng k√Ω callback. | `Unit` | Y√™u c·∫ßu `Context` v√† `Uri` c·ªßa file |
| `createFile(context: Context, fileName: String, fileType: String = "xlsx", callback: DocumentCallback)` | T·∫°o file m·ªõi trong `MediaStore` t·ª´ template c√≥ s·∫µn, sau ƒë√≥ t·ª± ƒë·ªông m·ªü b·∫±ng LibreOffice. | `suspend Unit` | Y√™u c·∫ßu `Context` v√† ch·∫°y trong coroutine |
| `openSystemPicker(context: Context, callback: DocumentCallback)` | M·ªü tr√¨nh ch·ªçn file h·ªá th·ªëng v·ªõi danh s√°ch MIME types h·ªó tr·ª£. | `Unit` | Y√™u c·∫ßu `Context`, fallback sang `ACTION_GET_CONTENT` n·∫øu c·∫ßn |
| `registerDocumentPicker(activity: ComponentActivity)` | ƒêƒÉng k√Ω launcher cho `ActivityResultContracts.OpenDocument` trong Activity. | `Unit` | Ph·∫£i g·ªçi tr∆∞·ªõc khi s·ª≠ d·ª•ng system picker |
| `registerDocumentPicker(fragment: Fragment, context: Context)` | ƒêƒÉng k√Ω launcher cho `ActivityResultContracts.OpenDocument` trong Fragment. | `Unit` | Ph·∫£i g·ªçi tr∆∞·ªõc khi s·ª≠ d·ª•ng system picker |
| `setIDAdsBanner(context: Context, idAdsBanner: String)` | Thi·∫øt l·∫≠p ID qu·∫£ng c√°o banner | `Unit` | Ph·∫£i g·ªçi khi d√πng LibreOffice |
| `setStateShowAds(context: Context, stateShowAds: Boolean)` | B·∫≠t/t·∫Øt hi·ªÉn th·ªã qu·∫£ng c√°o | `Unit` | Ph·∫£i g·ªçi khi d√πng LibreOffice |

### üí° Usage Examples

#### üîπ 1. M·ªü file LibreOffice
```kotlin
UtilsOffice.openFile(context, fileUri, object : DocumentCallback {
  override fun onDocumentClosed() {
    // X·ª≠ l√Ω khi LibreOffice ƒë√≥ng
    Log.d("DocumentAction", "LibreOffice document closed")
  }

  override fun onAdRevenueReceived(
    valueMicros: Long,
    currencyCode: String,
    precisionType: Int
  ) {
    // X·ª≠ l√Ω doanh thu qu·∫£ng c√°o
    Log.d("AdRevenue", "Revenue: $valueMicros $currencyCode")
  }
})
```

#### üîπ 2. T·∫°o file m·ªõi v√† m·ªü b·∫±ng LibreOffice
```kotlin
lifecycleScope.launch {
  UtilsOffice.createFile(
    context = this@MainActivity,
    fileName = "NewReport",
    fileType = "xlsx",
    callback = object : DocumentCallback {
      override fun onDocumentClosed() {
        // X·ª≠ l√Ω khi file m·ªõi ƒë∆∞·ª£c t·∫°o v√† LibreOffice ƒë√≥ng
        Log.d("FileCreation", "New document created and closed")
      }

      override fun onAdRevenueReceived(
        valueMicros: Long,
        currencyCode: String,
        precisionType: Int
      ) {
        // X·ª≠ l√Ω doanh thu qu·∫£ng c√°o t·ª´ file m·ªõi
        Log.d("AdRevenue", "Revenue from new file: $valueMicros $currencyCode")
      }
    }
  )
}
```

#### üîπ 3. M·ªü tr√¨nh ch·ªçn file h·ªá th·ªëng (Activity)
```kotlin
class MainActivity : AppCompatActivity() {
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)

    // ƒêƒÉng k√Ω document picker tr∆∞·ªõc khi s·ª≠ d·ª•ng
    UtilsOffice.registerDocumentPicker(this)

    // M·ªü system picker
    UtilsOffice.openSystemPicker(this, object : DocumentCallback {
      override fun onDocumentClosed() {
        // X·ª≠ l√Ω khi file ƒë∆∞·ª£c ch·ªçn v√† LibreOffice ƒë√≥ng
        Log.d("SystemPicker", "Document selected and closed")
      }

      override fun onAdRevenueReceived(
        valueMicros: Long,
        currencyCode: String,
        precisionType: Int
      ) {
        // X·ª≠ l√Ω doanh thu qu·∫£ng c√°o t·ª´ file ƒë∆∞·ª£c ch·ªçn
        Log.d("AdRevenue", "Revenue from picked file: $valueMicros $currencyCode")
      }
    })
  }
}
```

#### üîπ 3b. M·ªü tr√¨nh ch·ªçn file h·ªá th·ªëng (Fragment)
```kotlin
class DocumentFragment : Fragment() {
  override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
    super.onViewCreated(view, savedInstanceState)

    // ƒêƒÉng k√Ω document picker trong Fragment
    UtilsOffice.registerDocumentPicker(this, requireContext())

    // M·ªü system picker
    UtilsOffice.openSystemPicker(requireContext(), object : DocumentCallback {
      override fun onDocumentClosed() {
        Log.d("SystemPicker", "Document selected and closed")
      }

      override fun onAdRevenueReceived(
        valueMicros: Long,
        currencyCode: String,
        precisionType: Int
      ) {
        Log.d("AdRevenue", "Revenue from picked file: $valueMicros $currencyCode")
      }
    })
  }
}
```

### üåü Qu·∫£n L√Ω Qu·∫£ng C√°o

#### üîπ 4. Thi·∫øt L·∫≠p ID Qu·∫£ng C√°o Banner
```kotlin
class MainActivity : AppCompatActivity() {
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)

    // Thi·∫øt l·∫≠p ID qu·∫£ng c√°o banner
    UtilsOffice.setIDAdsBanner(
      context = this,
      idAdsBanner = "ca-app-pub-xxxxxxxxxxxxxxxx/xxxxxxxxxxxxxxxx"
    )
  }
}
```

#### üîπ 5. ƒêi·ªÅu Khi·ªÉn Hi·ªÉn Th·ªã Qu·∫£ng C√°o
```kotlin
class MainActivity : AppCompatActivity() {
  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)

    // B·∫≠t hi·ªÉn th·ªã qu·∫£ng c√°o
    UtilsOffice.setStateShowAds(
      context = this,
      stateShowAds = true
    )

    // T·∫Øt hi·ªÉn th·ªã qu·∫£ng c√°o
    // UtilsOffice.setStateShowAds(this, false)
  }
}
```

## üö® L∆∞u √ù Quan Tr·ªçng

### API Changes
- **T·∫§T C·∫¢ c√°c function** trong `UtilsOffice` ƒë·ªÅu y√™u c·∫ßu tham s·ªë `context: Context` l√†m tham s·ªë ƒë·∫ßu ti√™n
- S·ª≠ d·ª•ng `UtilsOffice.` prefix khi g·ªçi c√°c function (v√≠ d·ª•: `UtilsOffice.openFile()`)

### Quy T·∫Øc S·ª≠ D·ª•ng
- ‚úÖ Lu√¥n g·ªçi `UtilsOffice.registerDocumentPicker()` tr∆∞·ªõc khi s·ª≠ d·ª•ng `openSystemPicker()`
- ‚úÖ C√≥ 2 overload cho `registerDocumentPicker()`:
  - `registerDocumentPicker(activity: ComponentActivity)` - cho Activity
  - `registerDocumentPicker(fragment: Fragment, context: Context)` - cho Fragment
- ‚úÖ S·ª≠ d·ª•ng `createFile()` trong coroutine (suspend function)
- ‚úÖ Lu√¥n cung c·∫•p `DocumentCallback` ƒë·ªÉ x·ª≠ l√Ω c√°c s·ª± ki·ªán:
  - `onDocumentClosed()` - ƒë∆∞·ª£c g·ªçi khi ƒë√≥ng t√†i li·ªáu
  - `onAdRevenueReceived()` - ƒë∆∞·ª£c g·ªçi khi c√≥ doanh thu qu·∫£ng c√°o

### C·∫•u H√¨nh Qu·∫£ng C√°o
- **B·∫ÆT BU·ªòC:** Thi·∫øt l·∫≠p ID qu·∫£ng c√°o banner b·∫±ng `UtilsOffice.setIDAdsBanner(context, id)` tr∆∞·ªõc khi s·ª≠ d·ª•ng
- **B·∫ÆT BU·ªòC:** X√°c ƒë·ªãnh tr·∫°ng th√°i hi·ªÉn th·ªã qu·∫£ng c√°o b·∫±ng `UtilsOffice.setStateShowAds(context, state)`
  - `true`: Hi·ªÉn th·ªã qu·∫£ng c√°o
  - `false`: ·∫®n qu·∫£ng c√°o

## üîÑ Multi-Process Architecture

Library n√†y s·ª≠ d·ª•ng **multi-process architecture** v·ªõi 2 processes:
- **Main Process** (`com.your.package`): Process ch√≠nh c·ªßa ·ª©ng d·ª•ng
- **LOActivity Process** (`com.your.package:loactivity`): Process ri√™ng bi·ªát cho LibreOffice Editor

### ‚ö†Ô∏è QUAN TR·ªåNG: Application.onCreate() Pattern

Do library ch·∫°y trong 2 processes ri√™ng bi·ªát, `Application.onCreate()` s·∫Ω ƒë∆∞·ª£c g·ªçi **2 l·∫ßn** (m·ªói process 1 l·∫ßn). ƒê·ªÉ tr√°nh kh·ªüi t·∫°o kh√¥ng c·∫ßn thi·∫øt v√† xung ƒë·ªôt (v√≠ d·ª•: kh·ªüi t·∫°o Firebase, Analytics, v.v.), b·∫°n **PH·∫¢I** ki·ªÉm tra process name:

#### üîπ 6. C·∫•u H√¨nh Application Class (B·∫ÆT BU·ªòC)

```kotlin
class MyApplication : Application() {

    override fun onCreate() {
        super.onCreate()

        // ‚ö†Ô∏è QUAN TR·ªåNG: Ki·ªÉm tra process name ƒë·ªÉ tr√°nh kh·ªüi t·∫°o tr√πng l·∫∑p
        // Ch·ªâ ch·∫°y logic kh·ªüi t·∫°o trong main process
        val processName = getCurrentProcessNameCompat(this)
        if (processName != null && processName != applicationContext.packageName) {
            // ƒê√¢y l√† LOActivity process (:loactivity)
            // KH√îNG kh·ªüi t·∫°o c√°c service/SDK kh√¥ng c·∫ßn thi·∫øt
            return
        }

        // ‚úÖ Code b√™n d∆∞·ªõi CH·ªà ch·∫°y trong main process

        // Kh·ªüi t·∫°o Firebase, Analytics, Crash Reporting, v.v.
        FirebaseApp.initializeApp(this)

        // Kh·ªüi t·∫°o c√°c SDK kh√°c
        // ...
    }

    /**
     * L·∫•y t√™n process hi·ªán t·∫°i m·ªôt c√°ch t∆∞∆°ng th√≠ch v·ªõi m·ªçi phi√™n b·∫£n Android
     *
     * @param context Application context
     * @return T√™n process hi·ªán t·∫°i (v√≠ d·ª•: "com.your.package" ho·∫∑c "com.your.package:loactivity")
     *         ho·∫∑c null n·∫øu kh√¥ng th·ªÉ x√°c ƒë·ªãnh
     */
    private fun getCurrentProcessNameCompat(context: Context): String? {
        // Android P (API 28) tr·ªü l√™n: s·ª≠ d·ª•ng API ch√≠nh th·ª©c
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {
            return Application.getProcessName()
        }

        // Android O (API 27) tr·ªü xu·ªëng: ƒë·ªçc t·ª´ /proc/[pid]/cmdline
        return try {
            val pid = android.os.Process.myPid()
            val reader = File("/proc/$pid/cmdline").bufferedReader()
            reader.use { it.readLine()?.trim('\u0000') }
        } catch (e: Exception) {
            null
        }
    }
}
```

### T·∫°i sao c·∫ßn ki·ªÉm tra process name?

#### ‚ùå V·∫•n ƒë·ªÅ n·∫øu KH√îNG ki·ªÉm tra:

```kotlin
class MyApplication : Application() {
    override fun onCreate() {
        super.onCreate()

        // ‚ö†Ô∏è KH√îNG T·ªêT: Code n√†y s·∫Ω ch·∫°y 2 l·∫ßn!
        FirebaseApp.initializeApp(this)  // Kh·ªüi t·∫°o 2 l·∫ßn ‚Üí l√£ng ph√≠ t√†i nguy√™n
        initAnalytics()                   // C√≥ th·ªÉ g√¢y xung ƒë·ªôt
        setupDatabase()                   // Database c√≥ th·ªÉ b·ªã kh·ªüi t·∫°o tr√πng l·∫∑p
    }
}
```

**H·∫≠u qu·∫£:**
- üî¥ Firebase kh·ªüi t·∫°o 2 l·∫ßn ‚Üí t·ªën memory v√† CPU
- üî¥ Analytics tracking b·ªã duplicate ‚Üí s·ªë li·ªáu sai
- üî¥ Database connection conflicts ‚Üí crash app
- üî¥ Crash reporting SDK kh·ªüi t·∫°o 2 l·∫ßn ‚Üí b√°o c√°o sai
- üî¥ T·ªën th·ªùi gian kh·ªüi ƒë·ªông kh√¥ng c·∫ßn thi·∫øt

#### ‚úÖ Gi·∫£i ph√°p: Ki·ªÉm tra process name

```kotlin
val processName = getCurrentProcessNameCompat(this)
if (processName != null && processName != applicationContext.packageName) {
    // ƒê√¢y l√† :loactivity process ‚Üí KH√îNG kh·ªüi t·∫°o g√¨ c·∫£
    return
}

// ‚úÖ T·ªêT: Code n√†y CH·ªà ch·∫°y trong main process
FirebaseApp.initializeApp(this)  // ‚úÖ Ch·ªâ kh·ªüi t·∫°o 1 l·∫ßn
```

**L·ª£i √≠ch:**
- ‚úÖ Ti·∫øt ki·ªám memory v√† CPU
- ‚úÖ Tr√°nh xung ƒë·ªôt gi·ªØa c√°c processes
- ‚úÖ Kh·ªüi ƒë·ªông app nhanh h∆°n
- ‚úÖ Tracking ch√≠nh x√°c
- ‚úÖ Tr√°nh crash do duplicate initialization

### Chi ti·∫øt v·ªÅ `getCurrentProcessNameCompat()`

H√†m n√†y x√°c ƒë·ªãnh process name m·ªôt c√°ch t∆∞∆°ng th√≠ch v·ªõi m·ªçi phi√™n b·∫£n Android:

| Android Version | Method | Implementation |
|----------------|--------|----------------|
| Android P+ (API 28+) | `Application.getProcessName()` | API ch√≠nh th·ª©c, ƒë∆°n gi·∫£n v√† an to√†n |
| Android O- (API 27-) | ƒê·ªçc `/proc/[pid]/cmdline` | Fallback cho c√°c phi√™n b·∫£n c≈© |

**Return values:**
- `"com.your.package"` ‚Üí Main process
- `"com.your.package:loactivity"` ‚Üí LOActivity process
- `null` ‚Üí Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c (hi·∫øm g·∫∑p)
